---
// å¯¼å…¥ç±»å‹å®šä¹‰
import '../types/quiz.ts';
---

<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Brainrot Quiz</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      .animated-bg {
        background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
      }
      @keyframes gradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      .card-entrance {
        animation: cardSlideIn 0.6s ease-out;
      }
      @keyframes cardSlideIn {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .input-focus {
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }
      .input-focus:focus {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
    </style>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KNV6KMXTRC"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-KNV6KMXTRC');
    </script>
  </head>

  <body class="min-h-screen animated-bg flex items-center justify-center p-4">
    <div class="card-entrance bg-white/95 backdrop-blur-sm shadow-2xl rounded-3xl p-8 w-full max-w-md space-y-8">
      <!-- å¤´éƒ¨ -->
      <div class="text-center space-y-4">
        <div class="text-6xl mb-4">ğŸ®</div>
        <h1 id="title" class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
          é™æ—¶ç­”é¢˜
        </h1>
        <p class="text-gray-600">æµ‹è¯•ä½ çš„çŸ¥è¯†ï¼ŒæŒ‘æˆ˜ä½ çš„æé™ï¼</p>
      </div>

      <!-- è¯­è¨€å’Œé“¾æ¥ -->
      <div class="flex justify-between items-center">
        <a
          href="https://github.com/Axi404/brainrot-quiz"
          target="_blank"
          rel="noopener noreferrer"
          class="text-sm text-gray-600 hover:text-blue-600 transition-colors flex items-center space-x-1"
        >
          <span>ğŸ“š</span>
          <span>Github</span>
        </a>
        <button
          id="langSwitch"
          class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg transition-colors"
        >
          English
        </button>
      </div>

      <!-- è¡¨å• -->
      <form id="quiz-form" class="space-y-6">
        <!-- æ˜µç§°è¾“å…¥ -->
        <div class="space-y-2">
          <label for="nickname" class="block">
            <span id="nicknameLabel" class="text-gray-700 font-medium flex items-center space-x-2">
              <span>ğŸ‘¤</span>
              <span>è¯·è¾“å…¥æ˜µç§°</span>
            </span>
          </label>
          <input
            id="nickname"
            type="text"
            class="input-focus w-full p-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none"
            placeholder="ä½ çš„æ˜µç§°"
            maxlength="20"
            required
          />
          <div id="nickname-error" class="text-red-500 text-sm hidden">è¯·è¾“å…¥æœ‰æ•ˆçš„æ˜µç§°</div>
        </div>

        <!-- æ—¶é—´é€‰æ‹© -->
        <div class="space-y-2">
          <label for="duration" class="block">
            <span id="timeLabel" class="text-gray-700 font-medium flex items-center space-x-2">
              <span>â°</span>
              <span>é€‰æ‹©ç­”é¢˜æ—¶é—´</span>
            </span>
          </label>
          <select
            id="duration"
            class="input-focus w-full p-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none bg-white"
          >
            <option value="10">âš¡ 10 ç§’ (é—ªç”µæ¨¡å¼)</option>
            <option value="60" selected>ğŸ”¥ 1 åˆ†é’Ÿ (æ ‡å‡†æ¨¡å¼)</option>
            <option value="180">ğŸ’ª 3 åˆ†é’Ÿ (æŒ‘æˆ˜æ¨¡å¼)</option>
            <option value="300">ğŸ† 5 åˆ†é’Ÿ (ä¸“å®¶æ¨¡å¼)</option>
          </select>
        </div>

        <!-- å¼€å§‹æŒ‰é’® -->
        <button
          type="submit"
          id="start-btn"
          class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white p-4 rounded-xl font-semibold text-lg transition-all duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed active:scale-95"
        >
          <span id="start-btn-text">ğŸš€ å¼€å§‹ç­”é¢˜</span>
          <div id="start-btn-loading" class="hidden flex items-center justify-center">
            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
            <span>å‡†å¤‡ä¸­...</span>
          </div>
        </button>
      </form>

      <!-- æ¸¸æˆè¯´æ˜ -->
      <div class="bg-blue-50 p-4 rounded-xl">
        <h3 class="font-semibold text-blue-800 mb-2">ğŸ“– æ¸¸æˆè¯´æ˜</h3>
        <ul class="text-sm text-blue-700 space-y-1">
          <li>â€¢ æ ¹æ®éŸ³é¢‘é€‰æ‹©æ­£ç¡®çš„è§’è‰²å›¾ç‰‡</li>
          <li>â€¢ ç­”å¯¹å¾—1åˆ†ï¼Œç­”é”™æ‰£1åˆ†</li>
          <li>â€¢ æ—¶é—´ç»“æŸåè‡ªåŠ¨è·³è½¬åˆ°ç»“æœé¡µ</li>
          <li>â€¢ æ”¯æŒé‡æ’­éŸ³é¢‘å¸®åŠ©åˆ¤æ–­</li>
        </ul>
      </div>
    </div>

    <!-- é”™è¯¯æç¤ºæ¨¡æ€æ¡† -->
    <div
      id="error-modal"
      class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4">
        <div class="text-center space-y-4">
          <div class="text-5xl">âš ï¸</div>
          <h3 class="text-lg font-bold text-gray-800">æç¤º</h3>
          <p id="error-message" class="text-gray-600"></p>
          <button
            id="error-close"
            class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg"
          >
            ç¡®å®š
          </button>
        </div>
      </div>
    </div>

    <script>
      import { translations } from "../i18n/translations";
      import type { Language } from "../i18n/translations";
      import { 
        getElementById,
        getElement,
        safeSetTextContent,
        safeAddEventListener,
        toggleElement 
      } from "../utils/domHelpers";

      // ç±»å‹å®‰å…¨çš„å…ƒç´ è·å–
      const elements = {
        form: getElement<HTMLFormElement>("quiz-form"),
        nickname: getElement<HTMLInputElement>("nickname"),
        duration: getElement<HTMLSelectElement>("duration"),
        startBtn: getElement<HTMLButtonElement>("start-btn"),
        startBtnText: getElementById<HTMLSpanElement>("start-btn-text"),
        startBtnLoading: getElementById<HTMLDivElement>("start-btn-loading"),
        langSwitch: getElement<HTMLButtonElement>("langSwitch"),
        nicknameError: getElementById<HTMLDivElement>("nickname-error"),
        errorModal: getElementById<HTMLDivElement>("error-modal"),
        errorMessage: getElementById<HTMLParagraphElement>("error-message"),
        errorClose: getElementById<HTMLButtonElement>("error-close")
      };

      // å½“å‰è¯­è¨€
      let currentLang: Language = (localStorage.getItem("language") as Language) || "zh";

      // æ›´æ–°è¯­è¨€
      const updateLanguage = (lang: Language): void => {
        const t = translations[lang];
        const titleEl = getElementById("title");
        const nicknameLabel = getElementById("nicknameLabel");
        const timeLabel = getElementById("timeLabel");

        document.title = t.title;
        safeSetTextContent(titleEl, t.title);
        safeSetTextContent(nicknameLabel, t.enterNickname);
        safeSetTextContent(timeLabel, t.selectTime);
        
        if (elements.nickname) {
          elements.nickname.placeholder = t.nicknamePlaceholder;
        }
        
        // æ›´æ–°é€‰é¡¹æ–‡æœ¬
        if (elements.duration) {
          const options = elements.duration.options;
          options[0].text = `âš¡ 10 ${t.seconds} (é—ªç”µæ¨¡å¼)`;
          options[1].text = `ğŸ”¥ 1 ${t.minutes} (æ ‡å‡†æ¨¡å¼)`;
          options[2].text = `ğŸ’ª 3 ${t.minutes} (æŒ‘æˆ˜æ¨¡å¼)`;
          options[3].text = `ğŸ† 5 ${t.minutes} (ä¸“å®¶æ¨¡å¼)`;
        }
        
        safeSetTextContent(elements.startBtnText, `ğŸš€ ${t.startQuiz}`);
        safeSetTextContent(elements.langSwitch, lang === "zh" ? "English" : "ä¸­æ–‡");
      };

      // æ˜¾ç¤ºé”™è¯¯
      const showError = (message: string): void => {
        safeSetTextContent(elements.errorMessage, message);
        toggleElement(elements.errorModal, true);
      };

      // éšè—é”™è¯¯
      const hideError = (): void => {
        toggleElement(elements.errorModal, false);
      };

      // éªŒè¯æ˜µç§°
      const validateNickname = (nickname: string): boolean => {
        const trimmed = nickname.trim();
        if (trimmed.length === 0) {
          return false;
        }
        if (trimmed.length > 20) {
          return false;
        }
        // æ£€æŸ¥æ˜¯å¦åŒ…å«ç‰¹æ®Šå­—ç¬¦
        const validPattern = /^[a-zA-Z0-9\u4e00-\u9fa5_-]+$/;
        return validPattern.test(trimmed);
      };

      // è®¾ç½®åŠ è½½çŠ¶æ€
      const setLoading = (loading: boolean): void => {
        if (elements.startBtn) {
          elements.startBtn.disabled = loading;
        }
        toggleElement(elements.startBtnText, !loading);
        toggleElement(elements.startBtnLoading, loading);
      };

      // å¤„ç†è¡¨å•æäº¤
      const handleSubmit = async (event: Event): Promise<void> => {
        event.preventDefault();
        
        const nickname = elements.nickname.value.trim();
        const duration = parseInt(elements.duration.value);
        const timeTrack = elements.duration.options[elements.duration.selectedIndex].text;

        // éªŒè¯æ˜µç§°
        if (!validateNickname(nickname)) {
          const t = translations[currentLang];
          showError(t.pleaseEnterNickname);
          elements.nickname.focus();
          return;
        }

        // è®¾ç½®åŠ è½½çŠ¶æ€
        setLoading(true);

        try {
          // æ¸…é™¤æ—§æ¸¸æˆæ•°æ®å¹¶ä¿å­˜æ–°æ•°æ®
          localStorage.setItem("nickname", nickname);
          localStorage.setItem("duration", duration.toString());
          localStorage.setItem("timeTrack", timeTrack);
          localStorage.setItem("score", "0");
          localStorage.setItem("language", currentLang);
          localStorage.setItem("totalQuestions", "0");
          localStorage.setItem("correctAnswers", "0");
          localStorage.removeItem("timeLeft"); // æ¸…é™¤æ—§çš„æ—¶é—´è®°å½•

          // çŸ­æš‚å»¶è¿Ÿæ¨¡æ‹ŸåŠ è½½
          await new Promise(resolve => setTimeout(resolve, 500));

          // è·³è½¬åˆ°ç­”é¢˜é¡µ
          window.location.href = "/quiz";
        } catch (error) {
          console.error("å¯åŠ¨æ¸¸æˆå¤±è´¥:", error);
          showError("å¯åŠ¨æ¸¸æˆæ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚");
          setLoading(false);
        }
      };

      // å¤„ç†è¯­è¨€åˆ‡æ¢
      const handleLanguageSwitch = (): void => {
        currentLang = currentLang === "zh" ? "en" : "zh";
        localStorage.setItem("language", currentLang);
        updateLanguage(currentLang);
      };

      // å¤„ç†æ˜µç§°è¾“å…¥
      const handleNicknameInput = (): void => {
        const nickname = elements.nickname.value.trim();
        const isValid = validateNickname(nickname);
        
        toggleElement(elements.nicknameError, !isValid && nickname.length > 0);
        
        if (elements.nickname) {
          elements.nickname.classList.toggle("border-red-500", !isValid && nickname.length > 0);
          elements.nickname.classList.toggle("border-gray-200", isValid || nickname.length === 0);
        }
      };

      // äº‹ä»¶ç›‘å¬å™¨
      safeAddEventListener(elements.form, "submit", handleSubmit);
      safeAddEventListener(elements.langSwitch, "click", handleLanguageSwitch);
      safeAddEventListener(elements.nickname, "input", handleNicknameInput);
      safeAddEventListener(elements.errorClose, "click", hideError);

      // é”®ç›˜å¿«æ·é”®
      document.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !elements.startBtn?.disabled) {
          elements.form.dispatchEvent(new Event("submit"));
        }
      });

      // è‡ªåŠ¨èšç„¦æ˜µç§°è¾“å…¥æ¡†
      elements.nickname.focus();

      // åˆå§‹åŒ–è¯­è¨€
      updateLanguage(currentLang);
    </script>
  </body>
</html>
