---
// å¯¼å…¥ç±»å‹å®šä¹‰
import '../types/quiz.ts';
---

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>Brainrot Quiz</title>
    <meta name="viewport" content="width=device-width" />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      .quiz-option {
        transition: all 0.2s ease;
        cursor: pointer;
      }
      .quiz-option:active {
        transform: scale(0.98);
      }
      .quiz-option-appear {
        animation: optionAppear 0.4s ease-out forwards;
      }
      @keyframes optionAppear {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .pulse-animation {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-indigo-100 via-blue-100 to-purple-100 flex items-center justify-center min-h-screen"
  >
    <!-- åŠ è½½å±å¹• -->
    <div
      id="loading-screen"
      class="fixed inset-0 bg-white flex items-center justify-center z-50"
    >
      <div class="text-center space-y-4">
        <div class="loading-spinner mx-auto"></div>
        <p id="loading-text" class="text-gray-600">æ­£åœ¨åŠ è½½èµ„æº...</p>
        <div class="w-64 bg-gray-200 rounded-full h-2">
          <div id="loading-progress" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <!-- å¼€å§‹é®ç½©å±‚ -->
    <div
      id="start-overlay"
      class="fixed inset-0 backdrop-blur-sm bg-white/90 flex items-center justify-center z-40 transition-all duration-500 opacity-0 pointer-events-none"
    >
      <div
        class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center space-y-6 transform scale-95"
      >
        <div class="text-6xl mb-4">ğŸ§</div>
        <h2 class="text-2xl font-bold text-gray-800" id="ready">
          å‡†å¤‡å¥½äº†å—ï¼Ÿ
        </h2>
        <p class="text-sm text-gray-500" id="startDescription">
          ç‚¹å‡»æŒ‰é’®å¼€å§‹ç­”é¢˜å¹¶æ’­æ”¾éŸ³é¢‘
        </p>
        <button
          id="start-btn"
          class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-8 py-3 rounded-lg font-medium transform transition-all hover:scale-105 shadow-lg"
        >
          å¼€å§‹ç­”é¢˜
        </button>
      </div>
    </div>

    <!-- ä¸»é¡µé¢å†…å®¹ -->
    <div
      class="bg-white/95 backdrop-blur-sm p-8 rounded-3xl shadow-2xl w-full max-w-4xl text-center space-y-6"
    >
      <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
      <div class="flex justify-between items-center mb-6">
        <div class="flex items-center space-x-2">
          <span class="text-2xl">ğŸ‘¤</span>
          <span id="player-name" class="font-semibold text-gray-700">--</span>
        </div>
        <button
          id="langSwitch"
          class="text-sm text-gray-600 hover:text-gray-800 transition-colors duration-200 px-3 py-1 rounded bg-gray-100 hover:bg-gray-200"
        >
          English
        </button>
      </div>

      <!-- é¢˜ç›®æ ‡é¢˜ -->
      <div class="space-y-4">
        <h2 class="text-3xl font-extrabold text-gray-800">
          <span id="who-is-text">è°æ˜¯</span> <span id="question-name" class="text-indigo-600 pulse-animation">ï¼Ÿ</span>
      </h2>

        <!-- éŸ³é¢‘æ§åˆ¶ -->
        <div class="flex justify-center items-center space-x-4">
          <audio id="question-audio" preload="auto" class="hidden"></audio>
      <button
        id="replay-btn"
          class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg flex items-center space-x-2 transition-all duration-200 shadow-md active:scale-95"
      >
            <span class="text-xl">ğŸ”</span>
            <span>é‡æ’­éŸ³é¢‘</span>
      </button>
          <div id="audio-indicator" class="hidden">
            <div class="flex space-x-1">
              <div class="w-1 h-4 bg-green-500 rounded animate-pulse"></div>
              <div class="w-1 h-6 bg-green-500 rounded animate-pulse" style="animation-delay: 0.1s"></div>
              <div class="w-1 h-4 bg-green-500 rounded animate-pulse" style="animation-delay: 0.2s"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- é€‰é¡¹ç½‘æ ¼ -->
      <div id="options" class="grid grid-cols-2 gap-8 mt-8 max-w-2xl mx-auto"></div>

      <!-- åº•éƒ¨çŠ¶æ€æ  -->
      <div class="flex justify-between items-center pt-6 border-t border-gray-200">
        <div class="flex items-center space-x-2">
          <span class="text-2xl">â³</span>
          <span id="timer" class="text-xl font-bold text-red-500">60</span>
          <span class="text-gray-500">s</span>
        </div>
        <div class="flex items-center space-x-2">
          <span class="text-2xl">âœ…</span>
          <span class="text-gray-600">å¾—åˆ†ï¼š</span>
          <span id="score" class="text-xl font-bold text-green-500">0</span>
        </div>
      </div>
    </div>

    <!-- é”™è¯¯æç¤ºæ¨¡æ€æ¡† -->
    <div
      id="error-modal"
      class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4">
        <div class="text-center space-y-4">
          <div class="text-5xl">âš ï¸</div>
          <h3 class="text-lg font-bold text-gray-800">åŠ è½½å¤±è´¥</h3>
          <p id="error-message" class="text-gray-600">ç½‘ç»œè¿æ¥å‡ºç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥ã€‚</p>
          <button
            id="retry-btn"
            class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg"
          >
            é‡è¯•
          </button>
        </div>
      </div>
    </div>

    <script>
      import { translations } from "../i18n/translations";
      import type { Language } from "../i18n/translations";
      import { GameManager } from "../utils/gameManager";
      import {
        getElementById,
        getElement,
        safeSetTextContent,
        safeAddEventListener,
        createImageElement,
        toggleElement,
        toggleClass
      } from "../utils/domHelpers";

      // åˆå§‹åŒ–å˜é‡
      let currentLang: Language = (localStorage.getItem("language") as Language) || "zh";
      const gameManager = new GameManager();
      let currentAnswerIndex = -1;

      // DOM å…ƒç´ 
      const elements = {
        loadingScreen: getElementById<HTMLDivElement>("loading-screen"),
        loadingText: getElementById<HTMLParagraphElement>("loading-text"),
        loadingProgress: getElementById<HTMLDivElement>("loading-progress"),
        startOverlay: getElementById<HTMLDivElement>("start-overlay"),
        startBtn: getElementById<HTMLButtonElement>("start-btn"),
        playerName: getElementById<HTMLSpanElement>("player-name"),
        langSwitch: getElementById<HTMLButtonElement>("langSwitch"),
        whoIsText: getElementById<HTMLSpanElement>("who-is-text"),
        questionName: getElementById<HTMLSpanElement>("question-name"),
        questionAudio: getElementById<HTMLAudioElement>("question-audio"),
        replayBtn: getElementById<HTMLButtonElement>("replay-btn"),
        audioIndicator: getElementById<HTMLDivElement>("audio-indicator"),
        optionsContainer: getElementById<HTMLDivElement>("options"),
        timer: getElementById<HTMLSpanElement>("timer"),
        score: getElementById<HTMLSpanElement>("score"),
        errorModal: getElementById<HTMLDivElement>("error-modal"),
        errorMessage: getElementById<HTMLParagraphElement>("error-message"),
        retryBtn: getElementById<HTMLButtonElement>("retry-btn")
      };

      // æ›´æ–°è¯­è¨€
      const updateLanguage = (lang: Language): void => {
        const t = translations[lang];
        document.title = t.title;
        
        safeSetTextContent(elements.loadingText, t.loading);
        safeSetTextContent(getElementById("ready"), t.ready);
        safeSetTextContent(getElementById("startDescription"), t.startDescription);
        safeSetTextContent(elements.startBtn, t.startAnswering);
        safeSetTextContent(elements.whoIsText, t.whoIs);
        safeSetTextContent(elements.replayBtn, `ğŸ” ${t.replayAudio.substring(2)}`);
        safeSetTextContent(elements.langSwitch, lang === "zh" ? "English" : "ä¸­æ–‡");
      };

      // æ˜¾ç¤ºé”™è¯¯
      const showError = (message: string): void => {
        safeSetTextContent(elements.errorMessage, message);
        toggleElement(elements.errorModal, true);
      };

      // éšè—é”™è¯¯
      const hideError = (): void => {
        toggleElement(elements.errorModal, false);
      };

      // æ›´æ–°è¿›åº¦æ¡
      const updateProgress = (progress: number): void => {
        if (elements.loadingProgress) {
          elements.loadingProgress.style.width = `${progress}%`;
        }
      };

             // é¢„åŠ è½½èµ„æº
       const preloadAssets = async (): Promise<void> => {
         try {
           updateProgress(10);
           safeSetTextContent(elements.loadingText, "æ­£åœ¨åŠ è½½é¢˜åº“...");
           
           // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
           const progressInterval = setInterval(() => {
             const currentWidth = parseInt(elements.loadingProgress?.style.width || "10");
             if (currentWidth < 80) {
               updateProgress(currentWidth + 5);
             }
           }, 100);
           
           await gameManager.preloadAssets();
           
           clearInterval(progressInterval);
           updateProgress(100);
           safeSetTextContent(elements.loadingText, "åŠ è½½å®Œæˆï¼");
           
           setTimeout(() => {
             toggleElement(elements.loadingScreen, false);
             if (elements.startOverlay) {
               elements.startOverlay.classList.remove("opacity-0", "pointer-events-none");
               elements.startOverlay.classList.add("opacity-100");
             }
           }, 300);
         } catch (error) {
           console.error("é¢„åŠ è½½å¤±è´¥:", error);
           toggleElement(elements.loadingScreen, false);
           showError("èµ„æºåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å¹¶é‡è¯•ã€‚");
         }
       };

      // æ’­æ”¾éŸ³é¢‘
      const playAudio = async (audioSrc: string): Promise<void> => {
        if (!elements.questionAudio) return;
        
        try {
          elements.questionAudio.src = audioSrc;
          toggleElement(elements.audioIndicator, true);
          await elements.questionAudio.play();
          
          elements.questionAudio.onended = () => {
            toggleElement(elements.audioIndicator, false);
          };
        } catch (error) {
          console.error("éŸ³é¢‘æ’­æ”¾å¤±è´¥:", error);
          toggleElement(elements.audioIndicator, false);
        }
      };

      // ç”Ÿæˆæ–°é¢˜ç›®
      const askNewQuestion = async (shouldPlay = false): Promise<void> => {
        try {
          const { choices, answerIndex, answer } = gameManager.generateQuestion();
          currentAnswerIndex = answerIndex;

          // æ›´æ–°é¢˜ç›®åç§°
          safeSetTextContent(elements.questionName, answer.name);

          // æ’­æ”¾éŸ³é¢‘
          if (shouldPlay) {
            await playAudio(answer.audio);
          }

                     // æ¸…ç©ºå¹¶é‡æ–°ç”Ÿæˆé€‰é¡¹
           if (elements.optionsContainer) {
             elements.optionsContainer.innerHTML = "";
             
             choices.forEach((option, index) => {
               const optionDiv = document.createElement("div");
               optionDiv.className = "quiz-option quiz-option-appear relative";
               optionDiv.style.animationDelay = `${index * 0.1}s`;
               
               const img = createImageElement(
                 option.image,
                 option.name,
                 "w-full aspect-square object-cover rounded-xl border-4 border-transparent hover:border-blue-400 transition-all duration-200"
               );
               
               // ä¸æ˜¾ç¤ºåç§°æ ‡ç­¾ï¼Œé¿å…æ³„éœ²ç­”æ¡ˆ
               optionDiv.appendChild(img);
               
               optionDiv.addEventListener("click", () => handleAnswer(index));
               elements.optionsContainer!.appendChild(optionDiv);
             });
           }
        } catch (error) {
          console.error("ç”Ÿæˆé¢˜ç›®å¤±è´¥:", error);
          showError("ç”Ÿæˆé¢˜ç›®æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚");
        }
      };

      // å¤„ç†ç­”é¢˜
      const handleAnswer = (selectedIndex: number): void => {
        const isCorrect = selectedIndex === currentAnswerIndex;
        gameManager.updateScore(isCorrect);
        
        // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
        const gameState = gameManager.getGameState();
        safeSetTextContent(elements.score, gameState.score.toString());
        
        // è§†è§‰åé¦ˆ
        const options = elements.optionsContainer?.children;
        if (options) {
          Array.from(options).forEach((option, index) => {
            const element = option as HTMLElement;
            if (index === currentAnswerIndex) {
              element.classList.add("ring-4", "ring-green-500");
            } else if (index === selectedIndex && !isCorrect) {
              element.classList.add("ring-4", "ring-red-500");
            }
          });
        }
        
                 // çŸ­æš‚å»¶è¿Ÿåç»§ç»­ä¸‹ä¸€é¢˜
         setTimeout(() => {
            askNewQuestion(true);
         }, 10);
      };

             // å¼€å§‹æ¸¸æˆ
       const startGame = (): void => {
         try {
           gameManager.loadGameState();
           const gameState = gameManager.getGameState();
           
           // æ›´æ–°UI
           safeSetTextContent(elements.playerName, gameState.nickname);
           safeSetTextContent(elements.score, gameState.score.toString());
           safeSetTextContent(elements.timer, gameState.timeLeft.toString());
           
           // éšè—å¼€å§‹é®ç½©
           if (elements.startOverlay) {
             elements.startOverlay.classList.add("opacity-0", "pointer-events-none");
             // ç¡®ä¿é®ç½©å®Œå…¨ç§»é™¤
             setTimeout(() => {
               if (elements.startOverlay) {
                 elements.startOverlay.style.display = "none";
               }
             }, 500);
           }
           
           // å¼€å§‹è®¡æ—¶å™¨
           gameManager.startTimer(
             (timeLeft) => {
               safeSetTextContent(elements.timer, timeLeft.toString());
               
               // æ—¶é—´ä¸è¶³è­¦å‘Š
               if (timeLeft <= 10) {
                 elements.timer?.classList.add("text-red-600", "animate-pulse");
               }
             },
             () => {
            window.location.href = "/result";
          }
           );
           
           // ç«‹å³å¼€å§‹ç¬¬ä¸€é¢˜ï¼Œä¸å»¶è¿Ÿ
           askNewQuestion(true);
         } catch (error) {
           console.error("å¯åŠ¨æ¸¸æˆå¤±è´¥:", error);
           showError("å¯åŠ¨æ¸¸æˆæ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚");
         }
       };

      // äº‹ä»¶ç›‘å¬å™¨
      safeAddEventListener(elements.startBtn, "click", startGame);
      
      safeAddEventListener(elements.replayBtn, "click", () => {
        const gameState = gameManager.getGameState();
        if (gameState.currentQuestion) {
          playAudio(gameState.currentQuestion.audio);
        }
      });
      
      safeAddEventListener(elements.langSwitch, "click", () => {
        currentLang = currentLang === "zh" ? "en" : "zh";
        localStorage.setItem("language", currentLang);
        updateLanguage(currentLang);
      });
      
      safeAddEventListener(elements.retryBtn, "click", () => {
        hideError();
        preloadAssets();
      });

      // åˆå§‹åŒ–
      updateLanguage(currentLang);
      preloadAssets();
    </script>
  </body>
</html>
