---
// å¯¼å…¥ç±»å‹å®šä¹‰
import '../types/quiz.ts';
---

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>Brainrot Quiz - ç»“æœ</title>
    <meta name="viewport" content="width=device-width" />
    <link 
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" 
      rel="stylesheet" 
    />
    <style>
      .celebration {
        animation: celebration 2s ease-in-out;
      }
      @keyframes celebration {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
      }
      .score-animation {
        animation: scoreCount 2s ease-out;
      }
      @keyframes scoreCount {
        from { 
          transform: scale(0);
          opacity: 0;
        }
        to { 
          transform: scale(1);
          opacity: 1;
        }
      }
      .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        background: #f39c12;
        animation: confetti-fall 3s ease-in-out infinite;
      }
      @keyframes confetti-fall {
        0% {
          transform: translateY(-100vh) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: translateY(100vh) rotate(720deg);
          opacity: 0;
        }
      }
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
    </style>
  </head>
  
  <body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <!-- å½©å¸¦æ•ˆæœ -->
    <div id="confetti-container" class="fixed inset-0 pointer-events-none z-10"></div>
    
    <div class="bg-white/95 backdrop-blur-sm p-8 rounded-3xl shadow-2xl max-w-lg w-full text-center space-y-8 relative">
      <!-- è¯­è¨€åˆ‡æ¢ -->
      <div class="flex justify-end">
        <button 
          id="langSwitch" 
          class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg transition-colors duration-200"
        >
          English
        </button>
      </div>
      
      <!-- æ ‡é¢˜ -->
      <div class="celebration space-y-4">
        <div class="text-6xl">ğŸ‰</div>
        <h1 id="quizEnd" class="text-4xl font-extrabold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">
          ç­”é¢˜ç»“æŸ
        </h1>
      </div>

      <!-- ç©å®¶ä¿¡æ¯ -->
      <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-2xl">
        <div class="flex items-center justify-center space-x-3 mb-4">
          <span class="text-2xl">ğŸ‘¤</span>
          <span id="playerLabel" class="text-gray-600 font-medium">é€‰æ‰‹</span>
          <span class="text-gray-400">:</span>
          <span id="nickname" class="text-blue-700 font-bold text-lg">åŠ è½½ä¸­...</span>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mt-4">
          <div class="bg-white/70 p-3 rounded-xl">
            <div class="text-2xl mb-1">â°</div>
            <div class="text-sm text-gray-600" id="timeTrackLabel">æ—¶é—´èµ›é“</div>
            <div id="timeTrack" class="font-bold text-purple-600">åŠ è½½ä¸­...</div>
          </div>
          <div class="bg-white/70 p-3 rounded-xl">
            <div class="text-2xl mb-1">ğŸ¯</div>
            <div class="text-sm text-gray-600">ç­”é¢˜æ•°é‡</div>
            <div id="questionCount" class="font-bold text-indigo-600">-</div>
          </div>
        </div>
      </div>

      <!-- åˆ†æ•°æ˜¾ç¤º -->
      <div class="bg-gradient-to-r from-green-100 to-emerald-100 p-8 rounded-2xl shadow-inner">
        <div id="scoreLabel" class="text-xl text-gray-700 mb-4">ä½ çš„å¾—åˆ†</div>
        <div class="score-animation">
          <div id="score" class="text-7xl font-bold text-green-600 mb-2">0</div>
          <div id="scoreDescription" class="text-sm text-gray-600">åŠ è½½ä¸­...</div>
        </div>
        
        <!-- æˆç»©è¯„ä»· -->
        <div id="performance" class="mt-4 p-4 rounded-xl text-sm font-medium"></div>
      </div>

      <!-- ç»Ÿè®¡ä¿¡æ¯ -->
      <div class="grid grid-cols-3 gap-4">
        <div class="bg-blue-50 p-4 rounded-xl">
          <div class="text-xl">âœ…</div>
          <div class="text-xs text-gray-600">ç­”å¯¹</div>
          <div id="correctCount" class="font-bold text-blue-600">-</div>
        </div>
        <div class="bg-red-50 p-4 rounded-xl">
          <div class="text-xl">âŒ</div>
          <div class="text-xs text-gray-600">ç­”é”™</div>
          <div id="wrongCount" class="font-bold text-red-600">-</div>
        </div>
        <div class="bg-yellow-50 p-4 rounded-xl">
          <div class="text-xl">ğŸ“Š</div>
          <div class="text-xs text-gray-600">æ­£ç¡®ç‡</div>
          <div id="accuracy" class="font-bold text-yellow-600">-%</div>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div class="flex gap-4">
        <button 
          id="shareBtn" 
          class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-200 shadow-lg active:scale-95"
        >
          ğŸ”— åˆ†äº«æˆç»©
        </button>
        <button 
          id="restartBtn" 
          class="flex-1 bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-200 shadow-lg active:scale-95"
        >
          ğŸ”„ é‡æ–°å¼€å§‹
        </button>
      </div>

      <!-- æ’è¡Œæ¦œé¢„ç•™ä½ç½® -->
      <div class="bg-gray-50 p-4 rounded-xl">
        <div class="text-sm text-gray-500">ğŸ† å³å°†æ¨å‡ºæ’è¡Œæ¦œåŠŸèƒ½</div>
      </div>
    </div>

    <script>
      import { translations } from '../i18n/translations';
      import type { Language } from '../i18n/translations';
      import { 
        getElementById,
        getElement,
        safeSetTextContent,
        safeAddEventListener,
        toggleElement 
      } from '../utils/domHelpers';

      // ç±»å‹å®‰å…¨çš„å…ƒç´ è·å–
      const elements = {
        langSwitch: getElement<HTMLButtonElement>('langSwitch'),
        quizEnd: getElement<HTMLHeadingElement>('quizEnd'),
        playerLabel: getElement<HTMLSpanElement>('playerLabel'),
        nickname: getElement<HTMLSpanElement>('nickname'),
        timeTrackLabel: getElement<HTMLDivElement>('timeTrackLabel'),
        timeTrack: getElement<HTMLDivElement>('timeTrack'),
        questionCount: getElement<HTMLDivElement>('questionCount'),
        scoreLabel: getElement<HTMLDivElement>('scoreLabel'),
        score: getElement<HTMLDivElement>('score'),
        scoreDescription: getElement<HTMLDivElement>('scoreDescription'),
        performance: getElement<HTMLDivElement>('performance'),
        correctCount: getElement<HTMLDivElement>('correctCount'),
        wrongCount: getElement<HTMLDivElement>('wrongCount'),
        accuracy: getElement<HTMLDivElement>('accuracy'),
        shareBtn: getElement<HTMLButtonElement>('shareBtn'),
        restartBtn: getElement<HTMLButtonElement>('restartBtn'),
        confettiContainer: getElementById<HTMLDivElement>('confetti-container')
      };

      // å½“å‰è¯­è¨€
      let currentLang: Language = (localStorage.getItem('language') as Language) || 'zh';
      
      // æ¸¸æˆæ•°æ®
      interface GameResults {
        nickname: string;
        score: number;
        timeTrack: string;
        duration: number;
        totalQuestions: number;
        correctAnswers: number;
        wrongAnswers: number;
        accuracy: number;
      }

      // æ›´æ–°è¯­è¨€
      const updateLanguage = (lang: Language): void => {
        const t = translations[lang];
        
        document.title = `${t.title} - ç»“æœ`;
        safeSetTextContent(elements.quizEnd, t.quizEnd);
        safeSetTextContent(elements.playerLabel, t.player);
        safeSetTextContent(elements.scoreLabel, t.yourScore);
        safeSetTextContent(elements.timeTrackLabel, t.timeTrack);
        safeSetTextContent(elements.restartBtn, `ğŸ”„ ${t.restart}`);
        safeSetTextContent(elements.langSwitch, lang === 'zh' ? 'English' : 'ä¸­æ–‡');
      };

      // åˆ›å»ºå½©å¸¦æ•ˆæœ
      const createConfetti = (): void => {
        if (!elements.confettiContainer) return;
        
        const colors = ['#f39c12', '#e74c3c', '#9b59b6', '#3498db', '#2ecc71'];
        
        for (let i = 0; i < 50; i++) {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animationDelay = Math.random() * 3 + 's';
          confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
          
          elements.confettiContainer.appendChild(confetti);
          
          // 3ç§’åç§»é™¤å½©å¸¦
          setTimeout(() => {
            if (confetti.parentNode) {
              confetti.parentNode.removeChild(confetti);
            }
          }, 5000);
        }
      };

      // è®¡ç®—æ¸¸æˆç»“æœ
      const calculateResults = (): GameResults => {
        const nickname = localStorage.getItem('nickname') || 'åŒ¿å';
        const score = parseInt(localStorage.getItem('score') || '0');
        const timeTrack = localStorage.getItem('timeTrack') || 'æœªçŸ¥';
        const duration = parseInt(localStorage.getItem('duration') || '60');
        
        // ä½¿ç”¨å®é™…ç­”é¢˜æ•°æ®
        const totalQuestions = parseInt(localStorage.getItem('totalQuestions') || '0');
        const correctAnswers = parseInt(localStorage.getItem('correctAnswers') || '0');
        const wrongAnswers = Math.max(0, totalQuestions - correctAnswers);
        const accuracy = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
        
        return {
          nickname,
          score,
          timeTrack,
          duration,
          totalQuestions,
          correctAnswers,
          wrongAnswers,
          accuracy
        };
      };

      // è·å–æˆç»©è¯„ä»·
      const getPerformanceMessage = (accuracy: number, score: number): {text: string, className: string} => {
        if (score <= 0) {
          return {
            text: "ç»§ç»­åŠªåŠ›ï¼Œç†Ÿèƒ½ç”Ÿå·§ï¼",
            className: "bg-red-100 text-red-700"
          };
        } else if (accuracy >= 90) {
          return {
            text: "ğŸ† å¤ªæ£’äº†ï¼ä½ æ˜¯çœŸæ­£çš„å¤§å¸ˆï¼",
            className: "bg-yellow-100 text-yellow-700"
          };
        } else if (accuracy >= 75) {
          return {
            text: "ğŸŒŸ è¡¨ç°ä¼˜ç§€ï¼ç»§ç»­ä¿æŒï¼",
            className: "bg-green-100 text-green-700"
          };
        } else if (accuracy >= 50) {
          return {
            text: "ğŸ‘ ä¸é”™çš„æˆç»©ï¼è¿˜æœ‰è¿›æ­¥ç©ºé—´ï¼",
            className: "bg-blue-100 text-blue-700"
          };
        } else {
          return {
            text: "ğŸ’ª åŠ æ²¹ï¼å¤šç»ƒä¹ ä¼šæ›´å¥½çš„ï¼",
            className: "bg-orange-100 text-orange-700"
          };
        }
      };

      // åŠ¨ç”»æ›´æ–°åˆ†æ•°
      const animateScore = (finalScore: number): void => {
        let currentScore = 0;
        const increment = Math.max(1, Math.floor(finalScore / 20));
        const interval = setInterval(() => {
          currentScore += increment;
          if (currentScore >= finalScore) {
            currentScore = finalScore;
            clearInterval(interval);
          }
          safeSetTextContent(elements.score, currentScore.toString());
        }, 50);
      };

      // åˆ†äº«æˆç»©
      const shareResults = (results: GameResults): void => {
        const shareText = `æˆ‘åœ¨ Brainrot Quiz ä¸­å¾—äº† ${results.score} åˆ†ï¼æ­£ç¡®ç‡ ${results.accuracy}%ï¼ä½ èƒ½è¶…è¿‡æˆ‘å—ï¼Ÿ`;
        
        if (navigator.share) {
          navigator.share({
            title: 'Brainrot Quiz æˆç»©',
            text: shareText,
            url: window.location.origin
          });
        } else {
          // å¤åˆ¶åˆ°å‰ªè´´æ¿
          navigator.clipboard.writeText(`${shareText} ${window.location.origin}`).then(() => {
            alert('æˆç»©å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
          }).catch(() => {
            alert('åˆ†äº«é“¾æ¥ï¼š' + shareText);
          });
        }
      };

      // æ˜¾ç¤ºç»“æœ
      const displayResults = (): void => {
        const results = calculateResults();
        
        // æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
        safeSetTextContent(elements.nickname, results.nickname);
        safeSetTextContent(elements.timeTrack, results.timeTrack);
        safeSetTextContent(elements.questionCount, results.totalQuestions.toString());
        
        // åŠ¨ç”»æ˜¾ç¤ºåˆ†æ•°
        animateScore(results.score);
        
        // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        safeSetTextContent(elements.correctCount, results.correctAnswers.toString());
        safeSetTextContent(elements.wrongCount, results.wrongAnswers.toString());
        safeSetTextContent(elements.accuracy, `${results.accuracy}%`);
        
        // æ˜¾ç¤ºæˆç»©è¯„ä»·
        const performance = getPerformanceMessage(results.accuracy, results.score);
        safeSetTextContent(elements.performance, performance.text);
        elements.performance.className = `mt-4 p-4 rounded-xl text-sm font-medium ${performance.className}`;
        
        // æ˜¾ç¤ºåˆ†æ•°æè¿°
        const scoreDesc = results.score > 0 ? 
          `åœ¨ ${results.totalQuestions} é“é¢˜ä¸­ç­”å¯¹äº† ${results.correctAnswers} é“` :
          `éœ€è¦æ›´å¤šç»ƒä¹ æ¥æé«˜æˆç»©`;
        safeSetTextContent(elements.scoreDescription, scoreDesc);
        
        // å¦‚æœæˆç»©ä¸é”™ï¼Œæ˜¾ç¤ºå½©å¸¦æ•ˆæœ
        if (results.accuracy >= 75 || results.score >= 10) {
          setTimeout(createConfetti, 1000);
        }
      };

      // äº‹ä»¶ç›‘å¬å™¨
      safeAddEventListener(elements.langSwitch, 'click', () => {
          currentLang = currentLang === 'zh' ? 'en' : 'zh';
          localStorage.setItem('language', currentLang);
          updateLanguage(currentLang);
        });

            safeAddEventListener(elements.restartBtn, 'click', () => {
        // æ¸…é™¤æ¸¸æˆæ•°æ®
        localStorage.removeItem('score');
        localStorage.removeItem('timeLeft');
        localStorage.removeItem('totalQuestions');
        localStorage.removeItem('correctAnswers');
          window.location.href = '/';
        });

      safeAddEventListener(elements.shareBtn, 'click', () => {
        const results = calculateResults();
        shareResults(results);
      });

      // åˆå§‹åŒ–
      updateLanguage(currentLang);
      displayResults();
    </script>
  </body>
</html>
